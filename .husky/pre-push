#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get the current branch name
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“ Current branch: $current_branch"

# Check if pushing to protected branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âš ï¸  Warning: Pushing directly to main/master branch"
  echo "Consider using pull requests for better code review"
fi

# Run full test suite
echo "ğŸ§ª Running full test suite..."
npm run test:ci

# Run security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high

# Check for secrets in code (basic check)
echo "ğŸ” Checking for potential secrets..."
if git diff --cached --name-only | xargs grep -l -E "(password|secret|key|token|api_key)" | grep -v test | grep -v ".env.example"; then
  echo "âš ï¸  Warning: Potential secrets found in code. Please review carefully."
fi

# Check build
echo "ğŸ—ï¸  Running build check..."
npm run build

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
  echo "âŒ Error: You have uncommitted changes. Please commit or stash them before pushing."
  exit 1
fi

# Performance check for critical branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "development" ]; then
  echo "âš¡ Running performance benchmarks..."
  npm run test:performance || echo "âš ï¸  Warning: Performance tests failed or not available"
fi

# Check for merge conflicts markers
echo "ğŸ” Checking for merge conflict markers..."
if git diff --cached --name-only | xargs grep -l "<<<<<<< HEAD\|>>>>>>> \|=======" 2>/dev/null; then
  echo "âŒ Error: Merge conflict markers found in staged files"
  exit 1
fi

# Check for debug statements
echo "ğŸ› Checking for debug statements..."
if git diff --cached --name-only | grep -E '\.(ts|js)$' | grep -v test | xargs grep -l "debugger\|console\.debug" 2>/dev/null; then
  echo "âš ï¸  Warning: Debug statements found in staged files"
fi

# Validate package.json if it was modified
if git diff --cached --name-only | grep -q "package.json"; then
  echo "ğŸ“¦ Validating package.json..."
  npm run lint package.json || echo "âš ï¸  Warning: package.json validation failed"
fi

# Check for proper documentation updates
if git diff --cached --name-only | grep -E '\.(ts|js)$' | grep -v test | xargs grep -l "export.*function\|export.*class" 2>/dev/null; then
  if ! git diff --cached --name-only | grep -q "README.md\|docs/"; then
    echo "âš ï¸  Warning: New exports detected but no documentation updates found"
  fi
fi

echo "âœ… Pre-push checks completed successfully!"
echo "ğŸš€ Ready to push to $current_branch"
