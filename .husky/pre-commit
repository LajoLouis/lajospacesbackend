#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Run lint-staged for code formatting and linting
echo "üìù Checking code formatting and linting..."
npx lint-staged

# Run type checking
echo "üîç Running TypeScript type checking..."
npm run build

# Run unit tests for changed files
echo "üß™ Running unit tests..."
npm run test:unit -- --passWithNoTests --findRelatedTests --bail

# Check for security vulnerabilities
echo "üîí Checking for security vulnerabilities..."
npm audit --audit-level=moderate

# Check for TODO/FIXME comments in staged files
echo "üìã Checking for TODO/FIXME comments..."
git diff --cached --name-only | xargs grep -l "TODO\|FIXME" && echo "‚ö†Ô∏è  Warning: TODO/FIXME comments found in staged files" || echo "‚úÖ No TODO/FIXME comments found"

# Check for console.log statements in staged files (excluding test files)
echo "üö´ Checking for console.log statements..."
git diff --cached --name-only | grep -E '\.(ts|js)$' | grep -v test | xargs grep -l "console\.log" && echo "‚ùå Error: console.log statements found in staged files" && exit 1 || echo "‚úÖ No console.log statements found"

# Check for large files
echo "üìè Checking for large files..."
git diff --cached --name-only | xargs ls -la | awk '$5 > 1048576 { print $9 ": " $5 " bytes" }' | while read line; do
  if [ -n "$line" ]; then
    echo "‚ö†Ô∏è  Warning: Large file detected: $line"
  fi
done

echo "‚úÖ Pre-commit checks completed successfully!"
